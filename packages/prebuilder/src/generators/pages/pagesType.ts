import type { MaybeUndefined } from '@rtm/shared-types/CustomUtilityTypes';

import { StructureKind, Project } from 'ts-morph';

import type { PagesMetadatas, Page } from '../../types/Metadatas';

import {
  PAGES_FROM_CODEGEN_SCHEMA_TYPE_STR,
  AUTOGENERATED_CODE_COMMENT_STR,
  TS_MORPH_FORMATTER_SETTINGS,
  GENERATIONS_TARGET_FOLDER,
  PAGES_TYPE_STR,
  TAB_SIZE
} from '../../config';

export const HARDCODED_FALLBACK_TYPE_FIELDS = new Set(['path', 'url', 'head', 'tail', 'pathWithoutHead', 'nestingLevelTwo']);
const HARDCODED_FALLBACK_TYPE_FIELDS_to_a = Array.from(HARDCODED_FALLBACK_TYPE_FIELDS);

function generatePagesFromCodegenSchemaTypeContent(pagesArchitecture: PagesMetadatas) {
  // eslint-disable-next-line no-magic-numbers
  const maybeObjEntry: MaybeUndefined<[PropertyKey, Page[]]> = Object.entries(pagesArchitecture)[0];
  // eslint-disable-next-line no-magic-numbers
  const fields = maybeObjEntry === undefined ? HARDCODED_FALLBACK_TYPE_FIELDS_to_a : Object.keys(maybeObjEntry[1][0]);

  const typeAcc = [];
  for (const field of fields) typeAcc.push(`"${field}"` + ':' + 'string');
  const schemaStr = typeAcc.join(';') + ';';
  return schemaStr;
}

export default async function generatePagesType(
  pagesArchitecture: PagesMetadatas,
  pretty: boolean,
  __PAGES_TYPE_STR: string = PAGES_TYPE_STR,
  __TARGET_FOLDER: string = GENERATIONS_TARGET_FOLDER
) {
  const project = new Project();

  const sourceFile = project.createSourceFile(
    `${__TARGET_FOLDER}/${__PAGES_TYPE_STR}.ts`,
    {
      statements: [
        {
          type: JSON.stringify(pagesArchitecture, null, pretty ? TAB_SIZE : undefined),
          kind: StructureKind.TypeAlias,
          name: __PAGES_TYPE_STR,
          isExported: false
        }
      ],
      trailingTrivia: `export type ${PAGES_FROM_CODEGEN_SCHEMA_TYPE_STR} = {${generatePagesFromCodegenSchemaTypeContent(pagesArchitecture)}};\n`
    },
    { overwrite: true }
  );
  const oldTextLength = sourceFile.getText().length;

  // eslint-disable-next-line no-magic-numbers
  sourceFile.insertText(0, AUTOGENERATED_CODE_COMMENT_STR);
  sourceFile.insertText(oldTextLength + AUTOGENERATED_CODE_COMMENT_STR.length, `export default ${__PAGES_TYPE_STR};`);
  if (pretty) sourceFile.formatText(TS_MORPH_FORMATTER_SETTINGS);
  await sourceFile.save();
}
